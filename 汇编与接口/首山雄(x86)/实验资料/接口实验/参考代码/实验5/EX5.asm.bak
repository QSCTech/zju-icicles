;一个简单的电子钟，利用定时器用中断方式定时，用并行口控制LED的扫描

DSEG	SEGMENT
ADDRESS	DW	0DE00H	;实验板端口首地址
CSCS	DW	0	;用于保存原中断CS
IPIP	DW	0	;用于保存原中断IP
DISP	DB	0C0H,0F9H,0A4H,0B0H,099H,092H,082H,0F8H,080H,098H	;数码管显示段码
SG	DB	1110B,1101B,1011B,0111B		;位选
STAT	DB	0	;保存5259状态
STATUS	DB	0	;保存9052状态
TIME	DB	0,0,0,0	;初始时间00：00
CNT	DB	0	;计数值，满20为1秒
DSEG	ENDS
CSEG	SEGMENT
	ASSUME	CS:CSEG,DS:DSEG
MAIN	PROC	FAR
	MOV AX,DSEG
	MOV DS,AX
	MOV ES,AX

;设置计数器工作方式
	MOV DX,ADDRESS
	ADD DX,23H
	MOV AL,10110110B
	OUT DX,AL

	MOV DX,ADDRESS
	ADD DX,22H
	MOV AX,50000
	OUT DX,AL
	MOV AL,AH
	OUT DX,AL

;设置并口工作方式	
	MOV DX,ADDRESS
	ADD DX,3H
	MOV AL,10000000B
	OUT DX,AL

;关中断
	CLI

;取原中断，保存INT 72H
	MOV AX,3572H
	INT 21H
	MOV CSCS,ES
	MOV IPIP,BX

;设置新中断
	MOV AX,CS
	MOV DS,AX
	MOV DX,OFFSET INTS
	MOV AX,2572H
	INT 21H

;设置DS,ES
	MOV AX,DSEG
	MOV DS,AX
	MOV ES,AX

;使能9052
	MOV DX,0DD80H + 4CH
	IN AL,DX
	MOV STATUS,AL
	OR AL,5BH
	OUT DX,AL
	MOV DX,0DD80H + 4DH
	IN AL,DX
	OR AL,0CH
	OUT DX,AL

;开屏蔽
	IN AL,0A1H
	MOV STAT,AL
	AND AL,11111011B
	OUT 0A1H,AL

;开中断
	STI

;中断处理
	MOV DI,0H
;进位处理
LP:	CMP TIME[0],10
	JNZ LR

	MOV TIME[0],0
	ADD TIME[1],1
	CMP TIME[1],6
	JNZ LR

	MOV TIME[1],0
	ADD TIME[2],1
	CMP TIME[2],10
	JNZ LR

	MOV TIME[2],0
	ADD TIME[3],1
	CMP TIME[3],6
	JNZ LR

	MOV TIME[3],0

LR:	MOV DX,ADDRESS		;设置位选
	ADD DX,1H
	MOV AL,SG[DI]
	OUT DX,AL
	
	MOV DX,ADDRESS		;设置数码管段码
	MOV BL,TIME[DI]
	MOV BH,0
	MOV AL,DISP[BX]
	OUT DX,AL

	CALL DELAY		;延时

	INC DI
	
	CMP DI,4
	JNZ LP
	MOV DI,0
	JMP LP

;关中断
	CLI

;设置DS,ES
	MOV AX,DSEG
	MOV DS,AX
	MOV ES,AX

;5:屏蔽
	MOV AL,STAT
	OUT 0A1h,AL

;关闭9052
	MOV DX,0DD80H + 4CH
	mov AL,STATUS
	OUT DX,AL

;6:恢复原中断
	MOV DX,IPIP
	MOV AX,CSCS
	MOV DS,AX
	MOV AX,2572H
	INT 21H

;开中断
	STI

;返回DOS
	MOV AH,4CH
	INT 21H
MAIN	ENDP

;延时子程序
DELAY	PROC
	PUSH AX
	PUSH CX
	MOV AX,0H
L:	INC AX
	MOV CX,0H
R:	INC CX
	CMP CX,0FFH
	JNZ R
	CMP AX,0FFH
	JNZ L
	POP CX
	POP AX
	RET
DELAY	ENDP

;中断处理程序
INTS	PROC	FAR
;关中断
	CLI
;保护现场
	PUSH AX

;中断处理
	ADD CNT,1H
	CMP CNT,20
	JB IR

	MOV CNT,0H
	ADD TIME[0],1
